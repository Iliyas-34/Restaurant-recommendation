{% extends "base.html" %}
{% block title %}Profile | Restaurant Finder{% endblock %}
{% block content %}

<section class="profile-page">
  <div class="container">
    <!-- User Info -->
    <div class="user-card">
      <div class="row">
        <div class="user">
          <img class="avatar" src="{{ profile.avatar_url }}" alt="avatar" onerror="this.src='https://via.placeholder.com/80'" />
          <div>
            <h2 id="displayName">{{ profile.username }}</h2>
            <p id="displayEmail">{{ profile.email }}</p>
          </div>
        </div>
        <button class="edit-btn" id="editBtn">‚úèÔ∏è Edit Profile</button>
      </div>

      <!-- Edit Form -->
      <form id="editForm" class="edit-form" method="post" action="{{ url_for('edit_profile') }}">
        <div class="grid">
          <div>
            <label for="username">Name</label>
            <input type="text" id="username" name="username" value="{{ profile.username }}" required>
          </div>
          <div>
            <label for="email">Email</label>
            <input type="email" id="email" name="email" value="{{ profile.email }}" required>
          </div>
          <div class="col-span">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
        </div>
        <div class="actions">
          <button type="button" class="secondary" id="cancelEdit">Cancel</button>
          <button type="submit">Save Changes</button>
        </div>
      </form>
    </div>

    <!-- Orders & Wishlist -->
    <div class="grid-2">
      <div class="panel">
        <h3>üßæ Previous Orders</h3>
        <div id="orders"></div>
      </div>
      <div class="panel">
        <h3>‚ù§Ô∏è Wishlist</h3>
        <div id="wlist"></div>
      </div>
    </div>

    <!-- Logout -->
    <div class="logout">
      <button id="logoutBtn" class="logout-btn">üö™ Logout</button>
    </div>
  </div>
</section>

<style>
.profile-page { padding: 24px; }
.container { max-width: 1100px; margin: 0 auto; }
.user-card { background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); margin-bottom: 18px; }
.row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
.user { display: flex; align-items: center; gap: 12px; }
.avatar { width: 64px; height: 64px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
.edit-btn { background: var(--space-orange); color: #fff; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
.edit-form { display: none; margin-top: 12px; border-top: 1px solid #eee; padding-top: 12px; }
.edit-form.show { display: block; animation: fadeIn .2s ease-in; }
.grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
@media (min-width: 800px) { .grid { grid-template-columns: 1fr 1fr; } .col-span { grid-column: 1 / -1; } }
.edit-form label { font-weight: 600; color: var(--royal); }
.edit-form input { width: 100%; padding: 10px; border: 1px solid #cfd6dd; border-radius: 10px; background: #fafafa; }
.actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 8px; }
.actions .secondary { background: #e5e7eb; color: #111827; }
.actions button { background: var(--space-orange); color: #fff; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
.grid-2 { display: grid; grid-template-columns: 1fr; gap: 16px; }
@media (min-width: 900px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
.panel { background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
.order-card, .wish-card { border: 1px solid #eee; border-radius: 12px; padding: 12px; margin-bottom: 10px; background: #fff; }
.order-head { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
.order-items { display: none; margin-top: 8px; color: #374151; }
.order-items.show { display: block; }
.wish-card .row { align-items: center; }
.wish-card .remove { background: #b91c1c; color: #fff; border: none; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
.logout { display: flex; justify-content: center; margin-top: 16px; }
.logout-btn { background: #b91c1c; color: #fff; border: none; padding: 10px 18px; border-radius: 10px; cursor: pointer; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }
</style>

<script>
// Toggle edit form
document.addEventListener('DOMContentLoaded', function() {
  const editBtn = document.getElementById('editBtn');
  const form = document.getElementById('editForm');
  const cancel = document.getElementById('cancelEdit');
  if (editBtn && form) {
    editBtn.addEventListener('click', () => form.classList.toggle('show'));
  }
  if (cancel && form) {
    cancel.addEventListener('click', () => form.classList.remove('show'));
  }

  // Simple validation on submit (HTML5 required also applied)
  form && form.addEventListener('submit', (e) => {
    const email = document.getElementById('email').value.trim();
    if (!/^([^\s@]+)@([^\s@]+)\.[^\s@]+$/.test(email)) {
      e.preventDefault();
      alert('Please enter a valid email.');
    }
  });

  // Load orders
  fetch('/user/orders')
    .then(r => r.json())
    .then(list => {
      const wrap = document.getElementById('orders');
      if (!wrap) return;
      if (!list || list.length === 0) {
        wrap.innerHTML = '<p>No orders yet.</p>';
        return;
      }
      wrap.innerHTML = '';
      list.forEach(o => {
        const items = Array.isArray(o.items) ? o.items.map(i => `<li>${escapeHtml(i)}</li>`).join('') : '';
        const c = document.createElement('div');
        c.className = 'order-card';
        c.innerHTML = `
          <div class="order-head" onclick="this.nextElementSibling.classList.toggle('show')">
            <div>
              <b>${escapeHtml(o.restaurant || '')}</b><div class="text-sm">${escapeHtml(o.date || '')}</div>
            </div>
            <div><b>Total:</b> ${escapeHtml(String(o.total || ''))}</div>
          </div>
          <div class="order-items"><ul>${items}</ul></div>
        `;
        wrap.appendChild(c);
      });
    })
    .catch(() => {});

  // Load wishlist
  fetch('/user/wishlist')
    .then(r => r.json())
    .then(list => {
      const wrap = document.getElementById('wlist');
      if (!wrap) return;
      if (!list || list.length === 0) {
        wrap.innerHTML = '<p>No items in wishlist.</p>';
        return;
      }
      wrap.innerHTML = '';
      list.forEach(w => {
        const c = document.createElement('div');
        c.className = 'wish-card';
        c.innerHTML = `
          <div class="row">
            <div><b>${escapeHtml(w.name || '')}</b></div>
            <button class="remove" onclick="removeWish('${escapeJs(w.id || '')}', this)">Remove</button>
          </div>
        `;
        wrap.appendChild(c);
      });
    })
    .catch(() => {});

  // Logout
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      fetch('/logout', { method: 'POST' })
        .then(() => { window.location.href = '/'; })
        .catch(() => { window.location.href = '/'; });
    });
  }
});

function removeWish(id, btn) {
  fetch(`/wishlist/${encodeURIComponent(id)}`, { method: 'DELETE' })
    .then(res => {
      if (!res.ok) throw new Error('failed');
      const card = btn && btn.closest('.wish-card');
      if (card) card.remove();
    })
    .catch(() => alert('Unable to remove from wishlist.'));
}

function escapeHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function escapeJs(str) {
  return String(str).replace(/'/g, "\\'").replace(/\n/g, "\\n");
}
</script>

{% endblock %}


